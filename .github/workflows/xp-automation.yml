name: XP Automation

on:
  workflow_dispatch:        # Allows manual triggering

permissions:
  contents: read  # Least-privilege permissions for GITHUB_TOKEN

jobs:
  send-xp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3   # Updated from v2 for latest support

      - name: Run XP request
        run: |
          set -e
          echo "‚è≥ Waiting 10 seconds..."
          sleep 10
          echo "üì§ Sending XP request..."
          RESPONSE=$(curl --fail --show-error --ssl-no-revoke -s -w "%{http_code}" -o response.txt -X POST https://api.duolingopro.net/request \
            -H "Authorization: Bearer ${{ secrets.DUOLINGO_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"gain_type": "xp", "amount": 100}')
          HTTP_STATUS=$(tail -c 3 response.txt)
          BODY=$(head -c -3 response.txt)
          echo "üì® Response from server ($HTTP_STATUS):"
          echo "$BODY"
          if [[ "$HTTP_STATUS" -ne 200 ]]; then
            echo "‚ùå Request failed with status $HTTP_STATUS"
            exit 1
          fi
